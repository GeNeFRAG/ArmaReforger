<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>Arma Reforger Mortar Calculator | Fire Mission & Ballistics Tool</title>
    <meta name="title" content="Arma Reforger Mortar Calculator | Fire Mission & Ballistics Tool">
    <meta name="description" content="Free online mortar calculator for Arma Reforger. Calculate precise firing missions with grid coordinates, elevation, azimuth, fire for effect and time of flight. Supports US 60mm and Russian 82mm mortars.">
    <meta name="keywords" content="arma reforger, mortar calculator, firing missons, ballistics, grid coordinates, artillery calculator, mil system, US mortar, Russian mortar, game tool">
    <meta name="author" content="ArmaMortars.org">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://armamortars.org/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://armamortars.org/">
    <meta property="og:title" content="Arma Reforger Mortar Calculator | Fire Mission & Ballistics Tool">
    <meta property="og:description" content="Free online mortar calculator for Arma Reforger. Calculate precise firing missions with grid coordinates, elevation, azimuth, fire for effect and time of flight.">
    <meta property="og:image" content="https://armamortars.org/icon.png">
    <meta property="og:site_name" content="ArmaMortars.org">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://armamortars.org/">
    <meta name="twitter:title" content="Arma Reforger Mortar Calculator">
    <meta name="twitter:description" content="Free online mortar calculator for Arma Reforger. Calculate precise firing missons with grid coordinates.">
    <meta name="twitter:image" content="https://armamortars.org/icon.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#6b8e23">
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Arma Reforger Mortar Calculator",
      "url": "https://armamortars.org/",
      "description": "Calculate precise mortar firing missons for Arma Reforger with grid coordinates, elevation, and ballistics data",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "150"
      }
    }
    </script>
    
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1f1e 0%, #2a3532 100%);
            color: #e8e8e8;
            min-height: 100vh;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #6b8e23;
        }
        .logo {
            width: 80px;
            height: auto;
            filter: brightness(0) invert(1) drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        h1 {
            color: #c8d4a0;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 1.8em;
        }
        h2 {
            color: #b8c7a0;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 25px;
            margin-bottom: 15px;
            border-left: 4px solid #6b8e23;
            padding-left: 12px;
        }
        .container {
            background: rgba(35, 45, 42, 0.85);
            padding: 25px;
            border-radius: 4px;
            border: 1px solid #3a4a45;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #b8c7a0;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #4a5a52;
            border-radius: 2px;
            font-size: 14px;
            background: #2a3532;
            color: #e8e8e8;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #6b8e23;
            background: #323e3a;
        }
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        button {
            background: linear-gradient(180deg, #7a9f35 0%, #6b8e23 100%);
            color: white;
            padding: 14px 30px;
            border: 1px solid #5a7e1f;
            border-radius: 2px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        button:hover {
            background: linear-gradient(180deg, #8ab040 0%, #7a9f35 100%);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }
        button:active {
            transform: translateY(1px);
        }
        button:disabled {
            background: #4a5550;
            border-color: #3a4540;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .result {
            background: rgba(35, 45, 42, 0.9);
            padding: 20px;
            margin-top: 20px;
            border-radius: 4px;
            display: none;
            border: 1px solid #3a4a45;
        }
        .result.active {
            display: block;
        }
        .result.success {
            background: rgba(35, 45, 42, 0.85);
            border: 2px solid #6b8e23;
        }
        .result.error {
            background: rgba(35, 45, 42, 0.85);
            border: 2px solid #a85050;
        }
        .result h2 {
            margin-top: 0;
            color: #d8e4b0;
        }
        .solution-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .solution-item {
            background: rgba(20, 25, 22, 0.8);
            padding: 14px;
            border-radius: 2px;
            border: 1px solid #4a5a52;
        }
        .solution-item strong {
            display: block;
            color: #a8b898;
            font-size: 11px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .solution-item .value {
            font-size: 22px;
            color: #e8f4d0;
            font-weight: bold;
        }
        .info {
            background: rgba(60, 80, 95, 0.3);
            border: 1px solid #4a6a75;
            padding: 12px;
            border-radius: 2px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #b8c8d0;
        }
        #loading {
            text-align: center;
            padding: 40px 20px;
            color: #95a585;
            font-size: 16px;
        }
        .toggle-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(107, 142, 35, 0.1);
            border-radius: 8px;
        }
        .toggle-buttons {
            display: flex;
            gap: 10px;
        }
        .toggle-option {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 14px;
            flex: 1;
            text-align: center;
            white-space: nowrap;
        }
        .toggle-option.active {
            background: #6b8e23;
            border-color: #8fbc1e;
            box-shadow: 0 2px 8px rgba(107, 142, 35, 0.4);
        }
        .toggle-option:hover:not(.active) {
            background: rgba(255, 255, 255, 0.15);
        }
        .coord-mode {
            display: none;
        }
        .coord-mode.active {
            display: block;
        }
        @media (max-width: 600px) {
            .row {
                grid-template-columns: 1fr;
            }
            .solution-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main Header -->
    <header class="header">
        <img src="https://vectorseek.com/wp-content/uploads/2023/07/Arma-Reforger-Logo-Vector.svg-.png" alt="Arma Reforger Logo - Mortar Calculator" class="logo">
        <h1>Mortar Fire Mission Calculator</h1>
    </header>
    
    <!-- Main Content -->
    <main>
    <div id="loading" role="status" aria-live="polite">Loading ballistic data...</div>
    
    <div id="app" style="display: none;">
        <div class="info">
            ‚ÑπÔ∏è Enter mortar and target coordinates to calculate firing mission. Charge is automatically selected for optimal range.
        </div>
        
        <div class="toggle-container">
            <span style="font-weight: 500; color: #b8c7a0; text-align: center;">Coordinate Input:</span>
            <div class="toggle-buttons">
                <div class="toggle-option active" onclick="setCoordMode('grid')" id="toggleGrid">
                    üéØ Grid (047/069)
                </div>
                <div class="toggle-option" onclick="setCoordMode('meters')" id="toggleMeters">
                    üìè Meters (X/Y)
                </div>
            </div>
        </div>
        
        <div class="container">
            <h2>1Ô∏è‚É£ Weapon System</h2>
            
            <div class="row">
                <div class="form-group">
                    <label for="mortarType">Mortar Type</label>
                    <select id="mortarType">
                        <!-- Populated dynamically from ballistic-data.json -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="shellType">Ammunition Type</label>
                    <select id="shellType">
                        <!-- Populated dynamically from ballistic-data.json -->
                    </select>
                </div>
            </div>
            
            <h2>2Ô∏è‚É£ Mortar Position</h2>
                
                <!-- Grid Mode -->
                <div id="mortarGridMode" class="coord-mode active">
                    <div class="form-group">
                        <label for="mortarGrid">Grid Coordinates</label>
                        <input type="text" id="mortarGrid" placeholder="047/069 or 0475/0695" style="font-family: monospace; font-size: 16px;">
                        <small style="color: #999; display: block; margin-top: 5px;">3-digit (10m squares) or 4-digit (1m precision)</small>
                    </div>
                </div>
                
                <!-- Meters Mode -->
                <div id="mortarMetersMode" class="coord-mode">
                    <div class="form-group">
                        <div class="row">
                            <div class="form-group">
                                <label for="mortarX">X Coordinate (meters)</label>
                                <input type="number" id="mortarX" placeholder="4800" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="mortarY">Y Coordinate (meters)</label>
                                <input type="number" id="mortarY" placeholder="7049" step="0.1">
                            </div>
                        </div>
                        <small style="color: #999; display: block; margin-top: -15px;">Enter map coordinates in meters</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="mortarZ">Height (m ASL)</label>
                    <input type="number" id="mortarZ" placeholder="168" step="0.1">
                </div>
                
                <h2>Target Position</h2>
                
                <!-- Grid Mode -->
                <div id="targetGridMode" class="coord-mode active">
                    <div class="form-group">
                        <label for="targetGrid">Grid Coordinates</label>
                        <input type="text" id="targetGrid" placeholder="085/105 or 0850/1050" style="font-family: monospace; font-size: 16px;">
                        <small style="color: #999; display: block; margin-top: 5px;">3-digit (10m squares) or 4-digit (1m precision)</small>
                    </div>
                </div>
                
                <!-- Meters Mode -->
                <div id="targetMetersMode" class="coord-mode">
                    <div class="form-group">
                        <div class="row">
                            <div class="form-group">
                                <label for="targetX">X Coordinate (meters)</label>
                                <input type="number" id="targetX" placeholder="4696" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="targetY">Y Coordinate (meters)</label>
                                <input type="number" id="targetY" placeholder="5516" step="0.1">
                            </div>
                        </div>
                        <small style="color: #999; display: block; margin-top: -15px;">Enter map coordinates in meters</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="targetZ">Height (m ASL)</label>
                    <input type="number" id="targetZ" placeholder="64" step="0.1">
                </div>
                
                <div class="info" style="margin-top: 15px;">
                    üìç Range, Azimuth, and Height Difference will be computed automatically from coordinates
                </div>
            
            <h2>3Ô∏è‚É£ Fire Correction (Optional)</h2>
            
            <div class="info" style="margin-bottom: 15px;">
                üí° Adjust target based on observer corrections. Format: "Left 10, Add 20" or "Right 8, Drop 10"
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label for="correctionEnabled">
                        <input type="checkbox" id="correctionEnabled" style="margin-right: 8px; width: auto; height: auto;">
                        Enable Fire Correction
                    </label>
                </div>
            </div>
            
            <div id="correctionControls" style="display: none;">
                <div class="row">
                    <div class="form-group">
                        <label for="correctionLR">Left/Right Correction (meters)</label>
                        <input type="number" id="correctionLR" placeholder="0" step="1" value="0">
                        <small style="color: #999; display: block; margin-top: 5px;">+ = Right, - = Left</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="correctionAD">Add/Drop Correction (meters)</label>
                        <input type="number" id="correctionAD" placeholder="0" step="1" value="0">
                        <small style="color: #999; display: block; margin-top: 5px;">- = Drop (raise elevation/shoot closer), + = Add (lower elevation/shoot farther)</small>
                    </div>
                </div>
                
                <div id="correctionPreview" style="margin-top: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 5px; font-size: 14px; color: #ffa726; display: none;">
                    üìç <strong>Resulting correction:</strong> <span id="correctionText">Right 0, Add 0</span>
                </div>
                
                <button id="applyCorrection" style="background: linear-gradient(180deg, #d68910 0%, #c77808 100%); border-color: #b56907; margin-bottom: 20px;">
                    üîÑ Apply Correction
                </button>
            </div>
            
            <h2>4Ô∏è‚É£ Fire for Effect (Optional)</h2>
            
            <div class="info" style="margin-bottom: 15px;">
                üéØ Engage area targets with multiple rounds. Lateral sheaf for width coverage, linear sheaf for depth penetration. <strong>Uses corrected target coordinates if applied.</strong>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label for="ffeEnabled">
                        <input type="checkbox" id="ffeEnabled" style="margin-right: 8px; width: auto; height: auto;">
                        Enable Fire for Effect
                    </label>
                </div>
            </div>
            
            <div id="ffeControls" style="display: none;">
                <div class="row">
                    <div class="form-group">
                        <label for="ffePattern">Sheaf Type</label>
                        <select id="ffePattern">
                            <option value="perpendicular">Lateral Sheaf (Width Coverage)</option>
                            <option value="along-bearing">Linear Sheaf (Depth Penetration)</option>
                            <option value="circular">Circular Pattern (Area Saturation)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ffeRounds">Rounds per Salvo</label>
                        <select id="ffeRounds">
                            <option value="3">3 Rounds</option>
                            <option value="5" selected>5 Rounds</option>
                            <option value="6">6 Rounds</option>
                            <option value="8">8 Rounds</option>
                            <option value="9">9 Rounds</option>
                            <option value="12">12 Rounds</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="ffeSpacingGroup">
                    <label for="ffeSpacing">Round Interval (meters)</label>
                    <input type="number" id="ffeSpacing" placeholder="50" value="50" min="10" max="200" step="10">
                    <small style="color: #999; display: block; margin-top: 5px;">Spacing between rounds (10-200m)</small>
                </div>
                
                <div class="form-group" id="ffeRadiusGroup" style="display: none;">
                    <label for="ffeRadius">Circle Radius (meters)</label>
                    <input type="number" id="ffeRadius" placeholder="100" value="100" min="20" max="300" step="10">
                    <small style="color: #999; display: block; margin-top: 5px;">Distance from center to impact points (20-300m)</small>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="calculate" style="flex: 3;">Compute Fire Mission</button>
                <button id="reset" style="flex: 1; background: linear-gradient(180deg, #666 0%, #555 100%);">Reset</button>
            </div>
        </div>
        
        <div id="output" class="result"></div>
    </div>
    </main>
    
    <!-- Footer -->
    <footer style="text-align: center; padding: 20px; margin-top: 40px; color: #95a585; font-size: 12px; border-top: 1px solid #3a4a45;">
        <p>¬© 2025 ArmaMortars.org | Free Arma Reforger Mortar Calculator</p>
        <p>Accurate ballistic calculations for US 60mm & Russian 82mm mortars | Grid coordinate support</p>
        <p>
            <a href="https://github.com/GeNeFRAG/ArmaReforger/tree/main/mortar_core/" target="_blank" rel="noopener noreferrer" style="color: #8fbc1e; text-decoration: none;">‚≠ê View on GitHub</a>
            | 
            <a href="https://github.com/GeNeFRAG/ArmaReforger/blob/main/LICENSE" target="_blank" rel="noopener noreferrer" style="color: #8fbc1e; text-decoration: none;">üìÑ MIT License</a>
        </p>
    </footer>
    
    <script src="MortarCalculator.js?v=1.3.6"></script>
    <script>
        let ballisticDataLoaded = false;
        
        // Toggle between grid and meters coordinate input
        function setCoordMode(mode) {
            const gridModes = document.querySelectorAll('#mortarGridMode, #targetGridMode');
            const meterModes = document.querySelectorAll('#mortarMetersMode, #targetMetersMode');
            const toggleGrid = document.getElementById('toggleGrid');
            const toggleMeters = document.getElementById('toggleMeters');
            
            if (mode === 'grid') {
                gridModes.forEach(el => el.classList.add('active'));
                meterModes.forEach(el => el.classList.remove('active'));
                toggleGrid.classList.add('active');
                toggleMeters.classList.remove('active');
            } else {
                gridModes.forEach(el => el.classList.remove('active'));
                meterModes.forEach(el => el.classList.add('active'));
                toggleGrid.classList.remove('active');
                toggleMeters.classList.add('active');
            }
            
            // Clear all input fields
            document.getElementById('mortarGrid').value = '';
            document.getElementById('mortarX').value = '';
            document.getElementById('mortarY').value = '';
            document.getElementById('mortarZ').value = '';
            document.getElementById('targetGrid').value = '';
            document.getElementById('targetX').value = '';
            document.getElementById('targetY').value = '';
            document.getElementById('targetZ').value = '';
            
            // Clear red highlighting
            document.getElementById('targetGrid').style.color = '';
            document.getElementById('targetX').style.color = '';
            document.getElementById('targetY').style.color = '';
            
            // Reset correction flag
            window.correctionApplied = false;
            
            // Reset Fire Correction
            document.getElementById('correctionEnabled').checked = false;
            document.getElementById('correctionControls').style.display = 'none';
            document.getElementById('correctionLR').value = 0;
            document.getElementById('correctionAD').value = 0;
            
            // Reset Fire for Effect
            document.getElementById('ffeEnabled').checked = false;
            document.getElementById('ffeControls').style.display = 'none';
            document.getElementById('ffePattern').value = 'perpendicular';
            document.getElementById('ffeRounds').value = '5';
            document.getElementById('ffeSpacing').value = '50';
            document.getElementById('ffeRadius').value = '100';
            document.getElementById('ffeSpacingGroup').style.display = 'block';
            document.getElementById('ffeRadiusGroup').style.display = 'none';
            
            // Clear output
            const output = document.getElementById('output');
            output.innerHTML = '';
            output.className = 'result';
        }
        
        // Update correction preview to show doctrinal terms
        function updateCorrectionPreview() {
            const correctionLRInput = document.getElementById('correctionLR');
            const correctionADInput = document.getElementById('correctionAD');
            const correctionPreview = document.getElementById('correctionPreview');
            const correctionText = document.getElementById('correctionText');
            
            const lr = parseFloat(correctionLRInput.value) || 0;
            const ad = parseFloat(correctionADInput.value) || 0;
            
            if (lr === 0 && ad === 0) {
                correctionPreview.style.display = 'none';
                return;
            }
            
            const lrText = lr === 0 ? '' : (lr > 0 ? `Right ${Math.abs(lr)}` : `Left ${Math.abs(lr)}`);
            const adText = ad === 0 ? '' : (ad > 0 ? `Add ${Math.abs(ad)}` : `Drop ${Math.abs(ad)}`);
            
            let resultText = '';
            if (lrText && adText) {
                resultText = `${lrText}, ${adText}`;
            } else if (lrText) {
                resultText = lrText;
            } else if (adText) {
                resultText = adText;
            }
            
            correctionText.textContent = resultText;
            correctionPreview.style.display = 'block';
        }
        
        // Apply fire correction to target position
        function applyFireCorrectionUI() {
            const correctionLR = parseFloat(document.getElementById('correctionLR').value) || 0;
            const correctionAD = parseFloat(document.getElementById('correctionAD').value) || 0;
            
            // Reverse Add/Drop sign: negative input should move closer (raise elevation)
            const reversedAD = -correctionAD;
            
            if (correctionLR === 0 && reversedAD === 0) {
                return;
            }
            
            try {
                // Parse mortar position
                let mortarPos;
                const mortarGrid = document.getElementById('mortarGrid').value.trim();
                if (mortarGrid) {
                    const mortarZ = parseFloat(document.getElementById('mortarZ').value) || 0;
                    mortarPos = MortarCalculator.parsePosition({ grid: mortarGrid, z: mortarZ });
                } else {
                    const mortarX = parseFloat(document.getElementById('mortarX').value);
                    const mortarY = parseFloat(document.getElementById('mortarY').value);
                    const mortarZ = parseFloat(document.getElementById('mortarZ').value) || 0;
                    if (isNaN(mortarX) || isNaN(mortarY)) {
                        throw new Error('Enter mortar position first');
                    }
                    mortarPos = { x: mortarX, y: mortarY, z: mortarZ };
                }
                
                // Parse target position
                let targetPos;
                const targetGrid = document.getElementById('targetGrid').value.trim();
                if (targetGrid) {
                    const targetZ = parseFloat(document.getElementById('targetZ').value) || 0;
                    targetPos = MortarCalculator.parsePosition({ grid: targetGrid, z: targetZ });
                } else {
                    const targetX = parseFloat(document.getElementById('targetX').value);
                    const targetY = parseFloat(document.getElementById('targetY').value);
                    const targetZ = parseFloat(document.getElementById('targetZ').value) || 0;
                    if (isNaN(targetX) || isNaN(targetY)) {
                        throw new Error('Enter target position first');
                    }
                    targetPos = { x: targetX, y: targetY, z: targetZ };
                }
                
                // Apply fire correction
                const corrected = MortarCalculator.applyFireCorrection(mortarPos, targetPos, correctionLR, reversedAD);
                
                // Update target fields with corrected position and highlight in red
                const targetXInput = document.getElementById('targetX');
                const targetYInput = document.getElementById('targetY');
                const targetGridInput = document.getElementById('targetGrid');
                
                targetXInput.value = corrected.x.toFixed(1);
                targetYInput.value = corrected.y.toFixed(1);
                targetXInput.style.color = '#ff6b6b';
                targetYInput.style.color = '#ff6b6b';
                
                // Convert to grid if in grid mode
                const gridMode = document.getElementById('targetGridMode').classList.contains('active');
                if (gridMode) {
                    const gridCoords = MortarCalculator.metersToGrid(corrected.x, corrected.y, true);
                    targetGridInput.value = gridCoords;
                    targetGridInput.style.color = '#ff6b6b';
                }
                
                // Mark that correction was applied (for highlighting output)
                window.correctionApplied = true;
                
                // Automatically recalculate firing mission
                calculateSolution();
                
                // Reset correction input fields
                document.getElementById('correctionLR').value = 0;
                document.getElementById('correctionAD').value = 0;
                
                // Hide the correction preview
                updateCorrectionPreview();
                
            } catch (error) {
                console.error('Correction error:', error);
                const output = document.getElementById('output');
                output.className = 'result active error';
                output.innerHTML = `
                    <h2>‚ùå Correction Error</h2>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }
        
        // Get all available mortar types from loaded ballistic data
        function getAllMortarTypes() {
            try {
                return MortarCalculator.getAllMortarTypes();
            } catch (error) {
                console.warn('Could not get mortar types:', error);
                return [];
            }
        }
        
        // Get available shell types for a mortar from loaded ballistic data
        function getShellTypesForMortar(mortarId) {
            try {
                const config = MortarCalculator.getWeaponConfig(mortarId, 'HE');
                const mortar = config.mortar;
                
                return mortar.shellTypes.map(shell => ({
                    value: shell.type,
                    label: shell.name
                }));
            } catch (error) {
                console.warn('Could not get shell types:', error);
                return [];
            }
        }
        
        // Update mortar type options from ballistic data
        function updateMortarTypes() {
            const mortarTypeSelect = document.getElementById('mortarType');
            const currentValue = mortarTypeSelect.value;
            
            const availableMortars = getAllMortarTypes();
            
            // Sort: US mortars first, then others
            availableMortars.sort((a, b) => {
                const aIsUS = a.id === 'US' || a.id.startsWith('US_');
                const bIsUS = b.id === 'US' || b.id.startsWith('US_');
                if (aIsUS && !bIsUS) return -1;
                if (!aIsUS && bIsUS) return 1;
                return a.name.localeCompare(b.name);
            });
            
            mortarTypeSelect.innerHTML = '';
            availableMortars.forEach(mortar => {
                const option = document.createElement('option');
                option.value = mortar.id;
                option.textContent = `${mortar.name}`;
                mortarTypeSelect.appendChild(option);
            });
            
            // Restore previous selection if available, otherwise select US mortar
            const optionExists = availableMortars.some(m => m.id === currentValue);
            if (optionExists) {
                mortarTypeSelect.value = currentValue;
            } else if (availableMortars.length > 0) {
                const usMortar = availableMortars.find(m => m.id === 'US' || m.id.startsWith('US_'));
                mortarTypeSelect.value = usMortar ? usMortar.id : availableMortars[0].id;
            }
        }
        
        // Update shell type options based on mortar type
        function updateShellTypes() {
            const mortarType = document.getElementById('mortarType').value;
            const shellTypeSelect = document.getElementById('shellType');
            const currentValue = shellTypeSelect.value;
            
            const availableShells = getShellTypesForMortar(mortarType);
            
            shellTypeSelect.innerHTML = '';
            availableShells.forEach(shell => {
                const option = document.createElement('option');
                option.value = shell.value;
                option.textContent = shell.label;
                shellTypeSelect.appendChild(option);
            });
            
            // Restore previous selection if available, otherwise select first
            const optionExists = availableShells.some(s => s.value === currentValue);
            if (optionExists) {
                shellTypeSelect.value = currentValue;
            } else if (availableShells.length > 0) {
                shellTypeSelect.value = availableShells[0].value;
            }
        }
        
        // Load ballistic data on page load
        async function init() {
            const loading = document.getElementById('loading');
            const app = document.getElementById('app');
            
            try {
                await MortarCalculator.loadBallisticData('ballistic-data.json');
                ballisticDataLoaded = true;
                
                loading.style.display = 'none';
                app.style.display = 'block';
                
                // Initialize mortar types and shell types after data is loaded
                updateMortarTypes();
                updateShellTypes();
                
                console.log('‚úÖ Ballistic data loaded successfully');
            } catch (error) {
                loading.innerHTML = `
                    <div style="color: red;">
                        ‚ùå Error loading ballistic data: ${error.message}
                        <br>Make sure the HTTP server is running from the mortar_core directory.
                    </div>
                `;
                console.error('Error loading ballistic data:', error);
            }
        }
        
        // Setup event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const calculateBtn = document.getElementById('calculate');
            const mortarTypeSelect = document.getElementById('mortarType');
            
            // Update shell types when mortar type changes
            mortarTypeSelect.addEventListener('change', updateShellTypes);
            
            calculateBtn.addEventListener('click', calculateSolution);
            
            // Apply correction button
            const applyCorrectionBtn = document.getElementById('applyCorrection');
            applyCorrectionBtn.addEventListener('click', applyFireCorrectionUI);
            
            // Fire Correction toggle
            const correctionEnabled = document.getElementById('correctionEnabled');
            const correctionControls = document.getElementById('correctionControls');
            correctionEnabled.addEventListener('change', function() {
                correctionControls.style.display = this.checked ? 'block' : 'none';
            });
            
            // Fire Correction preview update - attach event listeners
            const correctionLRInput = document.getElementById('correctionLR');
            const correctionADInput = document.getElementById('correctionAD');
            
            correctionLRInput.addEventListener('input', updateCorrectionPreview);
            correctionADInput.addEventListener('input', updateCorrectionPreview);
            
            // Fire for Effect toggle
            const ffeEnabled = document.getElementById('ffeEnabled');
            const ffeControls = document.getElementById('ffeControls');
            ffeEnabled.addEventListener('change', function() {
                ffeControls.style.display = this.checked ? 'block' : 'none';
                
                // Recalculate when FFE is toggled
                const output = document.getElementById('output');
                if (output.classList.contains('active')) {
                    calculateSolution();
                }
            });
            
            // Fire for Effect pattern type change
            const ffePattern = document.getElementById('ffePattern');
            const ffeSpacingGroup = document.getElementById('ffeSpacingGroup');
            const ffeRadiusGroup = document.getElementById('ffeRadiusGroup');
            ffePattern.addEventListener('change', function() {
                if (this.value === 'circular') {
                    ffeSpacingGroup.style.display = 'none';
                    ffeRadiusGroup.style.display = 'block';
                } else {
                    ffeSpacingGroup.style.display = 'block';
                    ffeRadiusGroup.style.display = 'none';
                }
            });
            
            // Reset button
            const resetBtn = document.getElementById('reset');
            resetBtn.addEventListener('click', function() {
                // Clear all input fields
                document.getElementById('mortarGrid').value = '';
                document.getElementById('mortarX').value = '';
                document.getElementById('mortarY').value = '';
                document.getElementById('mortarZ').value = '';
                document.getElementById('targetGrid').value = '';
                document.getElementById('targetX').value = '';
                document.getElementById('targetY').value = '';
                document.getElementById('targetZ').value = '';
                
                // Clear red highlighting from corrected fields
                document.getElementById('targetGrid').style.color = '';
                document.getElementById('targetX').style.color = '';
                document.getElementById('targetY').style.color = '';
                
                // Reset correction flag
                window.correctionApplied = false;
                
                // Reset Fire Correction
                document.getElementById('correctionEnabled').checked = false;
                document.getElementById('correctionControls').style.display = 'none';
                document.getElementById('correctionLR').value = 0;
                document.getElementById('correctionAD').value = 0;
                updateCorrectionPreview();
                
                // Reset Fire for Effect
                document.getElementById('ffeEnabled').checked = false;
                document.getElementById('ffeControls').style.display = 'none';
                document.getElementById('ffePattern').value = 'perpendicular';
                document.getElementById('ffeRounds').value = '5';
                document.getElementById('ffeSpacing').value = '50';
                document.getElementById('ffeRadius').value = '100';
                document.getElementById('ffeSpacingGroup').style.display = 'block';
                document.getElementById('ffeRadiusGroup').style.display = 'none';
                
                // Clear output and remove error class
                const output = document.getElementById('output');
                output.innerHTML = '';
                output.className = 'result';
            });
            
            // Clear red highlighting when user manually edits target fields
            ['targetGrid', 'targetX', 'targetY'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    this.style.color = '';
                    window.correctionApplied = false;
                });
            });
            
            // Allow Enter key to trigger calculation
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') calculateSolution();
                });
            });
        });
        
        function calculateSolution() {
            if (!ballisticDataLoaded) {
                alert('Ballistic data not loaded yet. Please wait...');
                return;
            }
            
            const output = document.getElementById('output');
            
            // Clear previous results
            output.className = 'result';
            output.innerHTML = '';
            
            try {
                const mortarId = document.getElementById('mortarType').value;
                const shellType = document.getElementById('shellType').value;
                
                // Parse mortar position
                let mortarPos;
                const mortarGrid = document.getElementById('mortarGrid').value.trim();
                if (mortarGrid) {
                    const mortarZ = parseFloat(document.getElementById('mortarZ').value) || 0;
                    mortarPos = { grid: mortarGrid, z: mortarZ };
                } else {
                    const mortarX = parseFloat(document.getElementById('mortarX').value);
                    const mortarY = parseFloat(document.getElementById('mortarY').value);
                    const mortarZ = parseFloat(document.getElementById('mortarZ').value) || 0;
                    if (isNaN(mortarX) || isNaN(mortarY)) {
                        throw new Error('Enter either grid coordinates or X/Y meter values for mortar');
                    }
                    mortarPos = { x: mortarX, y: mortarY, z: mortarZ };
                }
                
                // Parse target position
                let targetPos;
                const targetGrid = document.getElementById('targetGrid').value.trim();
                if (targetGrid) {
                    const targetZ = parseFloat(document.getElementById('targetZ').value) || 0;
                    targetPos = { grid: targetGrid, z: targetZ };
                } else {
                    const targetX = parseFloat(document.getElementById('targetX').value);
                    const targetY = parseFloat(document.getElementById('targetY').value);
                    const targetZ = parseFloat(document.getElementById('targetZ').value) || 0;
                    if (isNaN(targetX) || isNaN(targetY)) {
                        throw new Error('Enter either grid coordinates or X/Y meter values for target');
                    }
                    targetPos = { x: targetX, y: targetY, z: targetZ };
                }
                
                // Check if Fire for Effect is enabled
                const ffeEnabled = document.getElementById('ffeEnabled').checked;
                
                if (ffeEnabled) {
                    // Fire for Effect mode
                    const ffePattern = document.getElementById('ffePattern').value;
                    const ffeRounds = parseInt(document.getElementById('ffeRounds').value);
                    
                    // Parse mortar and target positions to ensure they're in {x,y,z} format
                    const mortarParsed = MortarCalculator.parsePosition(mortarPos);
                    const targetParsed = MortarCalculator.parsePosition(targetPos);
                    
                    console.log('üéØ FFE Using Coordinates:');
                    console.log('  Target Position (input):', targetPos);
                    console.log('  Target Position (parsed):', targetParsed);
                    console.log('  Correction Applied:', window.correctionApplied ? 'YES (red coordinates)' : 'NO (original coordinates)');
                    
                    // Generate pattern positions based on pattern type
                    let targetPositions;
                    let patternParam;
                    
                    if (ffePattern === 'circular') {
                        const ffeRadius = parseFloat(document.getElementById('ffeRadius').value) || 100;
                        targetPositions = MortarCalculator.generateCircularPattern(
                            targetParsed,
                            ffeRadius,
                            ffeRounds
                        );
                        patternParam = ffeRadius;
                    } else {
                        const ffeSpacing = parseFloat(document.getElementById('ffeSpacing').value) || 50;
                        targetPositions = MortarCalculator.generateFireForEffectPattern(
                            mortarParsed,
                            targetParsed,
                            ffePattern,
                            ffeRounds,
                            ffeSpacing
                        );
                        patternParam = ffeSpacing;
                    }
                    
                    // Calculate solutions for each position
                    const ffeSolutions = [];
                    targetPositions.forEach((pos, index) => {
                        const input = MortarCalculator.prepareInput(mortarPos, pos, mortarId, shellType);
                        const solutions = MortarCalculator.calculateAllTrajectories(input);
                        if (solutions.length > 0 && solutions[0].inRange) {
                            ffeSolutions.push({
                                roundNumber: index + 1,
                                targetPos: pos,
                                input: input,
                                solution: solutions[0] // Use optimal solution
                            });
                        }
                    });
                    
                    // Sort by azimuth for easier gun traverse (always same direction)
                    const sortedFFE = MortarCalculator.sortFFESolutionsByAzimuth(ffeSolutions);
                    
                    // Display FFE results
                    if (sortedFFE.length > 0) {
                        output.className = 'result active success';
                        
                        let patternDesc, patternParamDesc;
                        if (ffePattern === 'perpendicular') {
                            patternDesc = 'Lateral Sheaf (Width Coverage)';
                            patternParamDesc = `Round Interval: ${patternParam}m`;
                        } else if (ffePattern === 'along-bearing') {
                            patternDesc = 'Linear Sheaf (Depth Penetration)';
                            patternParamDesc = `Round Interval: ${patternParam}m`;
                        } else {
                            patternDesc = 'Circular Pattern (Area Saturation)';
                            patternParamDesc = `Circle Radius: ${patternParam}m`;
                        }
                        
                        let ffeHTML = `
                            <h2>üí• Fire for Effect Mission</h2>
                            
                            ${window.correctionApplied ? '<div style="background: rgba(255, 107, 107, 0.15); padding: 10px; border-radius: 4px; border: 1px solid rgba(255, 107, 107, 0.3); margin-bottom: 15px; color: #ff9999; font-size: 13px;">üî¥ <strong>Fire correction applied:</strong> Red values include observer correction</div>' : ''}
                            
                            <div style="background: rgba(60, 75, 50, 0.4); padding: 12px; border-radius: 4px; border: 1px solid #6b8e23; margin-bottom: 15px; color: #d8e4b0;">
                                <strong>üìä Sheaf Type:</strong> ${patternDesc}<br>
                                <strong>üéØ Salvo Size:</strong> ${sortedFFE.length} of ${ffeRounds} rounds (in range)<br>
                                <strong>üìè ${patternParamDesc}</strong>
                            </div>
                            
                            <h3 style="font-size: 16px; margin-bottom: 10px;">Fire Mission Commands</h3>
                        `;
                        
                        sortedFFE.forEach(({ roundNumber, targetPos, input, solution }) => {
                            ffeHTML += `
                                <div style="background: rgba(35, 45, 42, 0.85); padding: 15px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #4a5a52;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h3 style="margin: 0; font-size: 16px; color: #c8d4a0;">
                                            Round ${roundNumber} of ${ffeRounds} - Charge ${solution.charge}
                                        </h3>
                                        <span style="font-size: 12px; color: #95a585; font-style: italic;">
                                            Range: ${input.distance.toFixed(1)}m | Alt Diff: ${input.heightDifference > 0 ? '+' : ''}${input.heightDifference.toFixed(1)}m
                                        </span>
                                    </div>
                                    <div class="solution-grid">
                                        <div class="solution-item">
                                            <strong>AZIMUTH</strong>
                                            <div class="value" ${window.correctionApplied ? 'style="color: #ff6b6b"' : ''}>${solution.azimuthMils} mils</div>
                                            <div style="color: ${window.correctionApplied ? '#ff6b6b' : '#95a585'}; font-size: 12px;">(${solution.azimuth}¬∞)</div>
                                        </div>
                                        <div class="solution-item">
                                            <strong>ELEVATION</strong>
                                            <div class="value" ${window.correctionApplied ? 'style="color: #ff6b6b"' : ''}>${solution.elevation} mils</div>
                                            <div style="color: ${window.correctionApplied ? '#ff6b6b' : '#95a585'}; font-size: 12px;">(${solution.elevationDegrees}¬∞)</div>
                                            ${solution.elevationCorrection && solution.elevationCorrection !== 0 ? `<div style="color: #95a585; font-size: 11px; margin-top: 2px;">dElev: ${solution.dElev} and Elevation Correction: ${solution.elevationCorrection > 0 ? '+' : ''}${solution.elevationCorrection.toFixed(1)} mils</div>` : ''}
                                        </div>
                                        <div class="solution-item">
                                            <strong>CHARGE</strong>
                                            <div class="value">${solution.charge}</div>
                                        </div>
                                        <div class="solution-item">
                                            <strong>TIME OF FLIGHT</strong>
                                            <div class="value">${solution.timeOfFlight}s</div>
                                            ${solution.tofCorrection && solution.tofCorrection !== 0 ? `<div style="color: #95a585; font-size: 11px; margin-top: 2px;">Correction: ${solution.tofCorrection > 0 ? '+' : ''}${solution.tofCorrection.toFixed(1)}s (TOF/100m: ${solution.tofPer100m})</div>` : ''}
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; padding: 8px; background: rgba(20, 25, 22, 0.6); border-radius: 3px; font-size: 12px; color: #a8b898;">
                                        <strong>Charge Range:</strong> ${solution.minRange}m - ${solution.maxRange}m
                                    </div>
                                </div>
                            `;
                        });
                        
                        output.innerHTML = ffeHTML;
                    } else {
                        throw new Error('No rounds in range for Fire for Effect pattern');
                    }
                    
                    return; // Exit early, don't run normal calculation
                }
                
                // Use prepareInput to calculate range, azimuth, and height difference
                const input = MortarCalculator.prepareInput(mortarPos, targetPos, mortarId, shellType);
                
                console.log('Mortar Position:', mortarPos);
                console.log('Target Position:', targetPos);
                console.log('Calculated Parameters:', {
                    distance: input.distance.toFixed(1) + 'm',
                    bearing: input.bearing.toFixed(1) + '¬∞',
                    bearingMils: MortarCalculator.degreesToMils(input.bearing) + ' mils',
                    heightDifference: input.heightDifference.toFixed(1) + 'm'
                });
                
                console.log('Input:', input);
                
                // Calculate all trajectory options
                const solutions = MortarCalculator.calculateAllTrajectories(input);
                
                console.log('Solutions:', solutions);
                
                // Generate trajectory data using MortarCalculator
                const trajectoryData = MortarCalculator.generateTrajectoryPoints(solutions, input.distance, input.mortarType);
                
                // Render SVG trajectories
                let trajectorySVG = '';
                if (trajectoryData.series && trajectoryData.series.length > 0) {
                    const svgTop = 30;
                    const groundY = 220;
                    const availablePx = groundY - svgTop;
                    const verticalScale = trajectoryData.globalMaxY > 0 ? availablePx / trajectoryData.globalMaxY : 1;
                    
                    trajectoryData.series.forEach((series, i) => {
                        const { color, elevDeg, points, charge, tof } = series;
                        
                        let svgPoints = points.map(p => {
                            const screenX = 50 + (p.x / trajectoryData.globalRange) * 500;
                            const screenY = groundY - p.y * verticalScale;
                            return screenX.toFixed(1) + ',' + screenY.toFixed(1);
                        });
                        
                        svgPoints[svgPoints.length - 1] = '550,' + groundY;
                        
                        const pathData = 'M ' + svgPoints.join(' L ');
                        const legendY = 30 + i * 25;
                        const textY = 34 + i * 25;
                        
                        trajectorySVG += '<path d="' + pathData + '" fill="none" stroke="' + color + '" stroke-width="2.5" opacity="0.8"/>';
                        trajectorySVG += '<circle cx="300" cy="' + legendY + '" r="4" fill="' + color + '"/>';
                        trajectorySVG += '<text x="310" y="' + textY + '" font-size="11" fill="' + color + '" font-weight="bold">';
                        trajectorySVG += 'Charge ' + charge + ': ' + elevDeg.toFixed(1) + '¬∞ (' + tof + 's)</text>';
                    });
                }
                
                // Display result
                output.className = 'result active';
                
                if (solutions.length > 0 && solutions[0].inRange) {
                    output.classList.add('success');
                    
                    let solutionsHTML = '';
                    
                    // Add correction hint if correction was applied
                    if (window.correctionApplied) {
                        solutionsHTML += '<div style="background: rgba(255, 107, 107, 0.15); padding: 10px; border-radius: 4px; border: 1px solid rgba(255, 107, 107, 0.3); margin-bottom: 15px; color: #ff9999; font-size: 13px;">üî¥ <strong>Fire correction applied:</strong> Red values include observer correction</div>';
                    }
                    
                    solutions.forEach((solution, index) => {
                        let trajectoryLabel;
                        if (index === 0) {
                            trajectoryLabel = 'üéØ Optimal Fire Mission';
                        } else {
                            trajectoryLabel = solution.trajectoryType === 'high' 
                                ? 'üîÑ Alternative Fire Mission (High Angle)' 
                                : 'üîÑ Alternative Fire Mission (Low Angle)';
                        }
                        
                        let chargeDesc = '';
                        if (index === 0) {
                            chargeDesc = solutions.length > 1 
                                ? `Fastest - ${solution.timeOfFlight}s flight time`
                                : 'Optimal solution';
                        } else {
                            const timeDiff = solution.timeOfFlight - solutions[0].timeOfFlight;
                            const elevDiff = solution.elevation - solutions[0].elevation;
                            const elevDegDiff = MortarCalculator.milsToDegrees(solution.elevation, input.mortarType) - MortarCalculator.milsToDegrees(solutions[0].elevation, input.mortarType);
                            const elevSign = elevDiff > 0 ? '+' : '';
                            chargeDesc = `+${timeDiff.toFixed(1)}s slower, ${elevSign}${elevDiff} mils (${elevSign}${elevDegDiff.toFixed(1)}¬∞) vs charge ${solutions[0].charge}`;
                        }
                        
                        solutionsHTML += `
                            <div style="background: ${index === 0 ? 'rgba(40, 55, 45, 0.9)' : 'rgba(35, 45, 42, 0.7)'}; padding: 15px; border-radius: 4px; margin-bottom: 10px; border: ${index === 0 ? '2px solid #6b8e23' : '1px solid #4a5a52'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0; font-size: 16px; color: ${index === 0 ? '#c8d4a0' : '#a8b898'};">
                                        ${trajectoryLabel} - Charge ${solution.charge}
                                    </h3>
                                    <span style="font-size: 12px; color: #95a585; font-style: italic;">
                                        ${chargeDesc}
                                    </span>
                                </div>
                                <div class="solution-grid">
                                    <div class="solution-item">
                                        <strong>AZIMUTH</strong>
                                        <div class="value" ${window.correctionApplied ? 'style="color: #ff6b6b"' : ''}>${solution.azimuthMils} mils</div>
                                        <div style="color: ${window.correctionApplied ? '#ff6b6b' : '#95a585'}; font-size: 12px;">(${solution.azimuth}¬∞)</div>
                                    </div>
                                    <div class="solution-item">
                                        <strong>ELEVATION</strong>
                                        <div class="value" ${window.correctionApplied ? 'style="color: #ff6b6b"' : ''}>${solution.elevation} mils</div>
                                        <div style="color: ${window.correctionApplied ? '#ff6b6b' : '#95a585'}; font-size: 12px;">(${solution.elevationDegrees}¬∞)</div>
                                        ${solution.elevationCorrection && solution.elevationCorrection !== 0 ? `<div style="color: #95a585; font-size: 11px; margin-top: 2px;">dElev: ${solution.dElev} and Elevation Correction: ${solution.elevationCorrection > 0 ? '+' : ''}${solution.elevationCorrection.toFixed(1)} mils</div>` : ''}
                                    </div>
                                    <div class="solution-item">
                                        <strong>CHARGE</strong>
                                        <div class="value">${solution.charge}</div>
                                    </div>
                                    <div class="solution-item">
                                        <strong>TIME OF FLIGHT</strong>
                                        <div class="value">${solution.timeOfFlight}s</div>
                                        ${solution.tofCorrection && solution.tofCorrection !== 0 ? `<div style="color: #95a585; font-size: 11px; margin-top: 2px;">Correction: ${solution.tofCorrection > 0 ? '+' : ''}${solution.tofCorrection.toFixed(1)}s (TOF/100m: ${solution.tofPer100m})</div>` : ''}
                                    </div>
                                </div>
                                <div style="margin-top: 10px; padding: 8px; background: rgba(20, 25, 22, 0.6); border-radius: 3px; font-size: 12px; color: #a8b898;">
                                    <strong>Charge Range:</strong> ${solution.minRange}m - ${solution.maxRange}m
                                </div>
                            </div>
                        `;
                    });
                    
                    output.innerHTML = `
                        <h2>‚úÖ Firing Mission${solutions.length > 1 ? 's' : ''} Found</h2>
                        
                        <div style="background: rgba(60, 75, 50, 0.4); padding: 12px; border-radius: 4px; border: 1px solid #6b8e23; margin-bottom: 15px; color: #d8e4b0;">
                            <strong>üìê Mil System:</strong> ${MortarCalculator.getMilSystemName(input.mortarType)} &nbsp;|&nbsp; 
                            <strong>üìè Range:</strong> ${input.distance.toFixed(1)}m &nbsp;|&nbsp; 
                            <strong>‚õ∞Ô∏è Alt Diff:</strong> ${input.heightDifference > 0 ? '+' : ''}${input.heightDifference.toFixed(1)}m
                        </div>
                        
                        ${solutions.length > 1 ? '<div style="background: rgba(60, 75, 50, 0.4); padding: 12px; border-radius: 4px; border: 1px solid #6b8e23; margin-bottom: 15px; color: #d8e4b0;"><strong>üí° Multiple Charge Options Available:</strong><br><small>Lower charges are more accurate but have limited range. Higher charges reach further but are less precise. High angle trajectories can clear obstacles.</small></div>' : ''}
                        
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Fire Missions (${solutions.length}): <span style="font-size: 16px; color: #ffffff; font-weight: normal;"></span></h3>
                        ${solutionsHTML}
                        
                        ${solutions.length > 1 ? `
                        <div style="background: rgba(35, 45, 42, 0.85); padding: 15px; border-radius: 4px; margin-top: 20px; margin-bottom: 15px; border: 1px solid #3a4a45;">
                            <h3 style="margin-top: 0; font-size: 16px; color: #d8e4b0;">üìä Trajectory Comparison</h3>
                            <svg width="100%" height="250" viewBox="0 0 600 250" style="background: #1a2422; border-radius: 4px;">
                                <!-- Ground and labels -->
                                <line x1="50" y1="220" x2="550" y2="220" stroke="#6b8e23" stroke-width="2"/>
                                <text x="50" y="240" text-anchor="middle" font-size="11" fill="#95a585">0m</text>
                                <text x="300" y="240" text-anchor="middle" font-size="11" fill="#95a585">${(input.distance/2).toFixed(0)}m</text>
                                <text x="550" y="240" text-anchor="middle" font-size="11" fill="#95a585">${input.distance.toFixed(0)}m</text>
                                
                                <!-- Mortar marker -->
                                <circle cx="50" cy="220" r="4" fill="#6b8e23"/>
                                <text x="50" y="210" text-anchor="middle" font-size="10" fill="#c8d4a0" font-weight="bold">M</text>
                                
                                ${trajectorySVG}
                            </svg>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(60, 75, 50, 0.4); border-radius: 4px; border: 1px solid #6b8e23; color: #d8e4b0;">
                            <strong>üéØ Recommended Fire Mission</strong><br>
                            <small>Charge ${solutions[0].charge} | Elevation ${solutions[0].elevation} mils | Azimuth ${solutions[0].azimuthMils} mils | TOF ${solutions[0].timeOfFlight}s</small>
                        </div>
                    `;
                } else {
                    const solution = solutions[0];
                    output.classList.add('error');
                    output.innerHTML = `
                        <h2>‚ùå Target Out of Range</h2>
                        <p><strong>Error:</strong> ${solution.error}</p>
                        ${solution.minRange && solution.maxRange ? `
                            <p>
                                <strong>Valid range for this configuration:</strong><br>
                                ${solution.minRange}m - ${solution.maxRange}m
                            </p>
                        ` : ''}
                        <p style="margin-top: 15px;">
                            <strong>Suggestions:</strong>
                        </p>
                        <ul>
                            <li>Try a different mortar type or shell type</li>
                            <li>Move mortar or target positions closer/further</li>
                        </ul>
                    `;
                }
            } catch (error) {
                output.className = 'result active error';
                output.innerHTML = `
                    <h2>‚ùå Calculation Error</h2>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Check your input values and try again.</p>
                `;
                console.error('Calculation error:', error);
            }
        }
        
        // Initialize on page load
        init();
    </script>
</body>
</html>
